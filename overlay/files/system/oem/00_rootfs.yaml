# Rootfs Kairos OEM configuration file
#
# This file is part of Kairos and will get reset during upgrades.
#
# Before you change this file manually,
# consider copying this file to /usr/local/cloud-config or
# copy the file with a prefix starting by 90, e.g. /oem/91_custom.yaml
name: "Rootfs Layout Settings"
stages:
  rootfs.before:
    - name: "Pull data from provider"
      datasource:
        providers: ["aws", "gcp", "openstack", "cdrom"]
        path: "/oem"
  rootfs:
    - if: '[ ! -f "/run/cos/recovery_mode" ] &&  [ ! -e "/run/cos/uki_mode" ]'
      name: "Layout configuration"
      environment_file: /run/cos/cos-layout.env
      environment:
        VOLUMES: "LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local"
        OVERLAY: "tmpfs:25%"
    - if: '[ -f "/run/cos/recovery_mode" ]'
      # omit the persistent partition on recovery mode
      name: "Layout configuration"
      environment_file: /run/cos/cos-layout.env
      environment:
        VOLUMES: "LABEL=COS_OEM:/oem"
        OVERLAY: "tmpfs:25%"
  initramfs:
    - if: '[ ! -f "/run/cos/recovery_mode" ] && [ -s /usr/local/etc/machine-id ]'
      name: "Restore /etc/machine-id"
      commands:
        - cat /usr/local/etc/machine-id > /etc/machine-id
    - if: '[ ! -f "/run/cos/recovery_mode" ] && [ -s /var/lib/dbus/machine-id ]'
      name: "Restore /etc/machine-id for openrc systems"
      commands:
        - cat /var/lib/dbus/machine-id > /etc/machine-id
  fs:
    - if: '[ ! -f "/run/cos/recovery_mode" ] && [ ! -s /usr/local/etc/machine-id ] '
      name: "Save /etc/machine-id"
      commands:
      - |
        mkdir -p /usr/local/etc
        cp /etc/machine-id /usr/local/etc
    - if: '[ ! -f "/run/cos/recovery_mode" ] && [ ! -s /var/lib/dbus/machine-id ] '
      name: "Save /etc/machine-id for openrc systems"
      commands:
        - |
          mkdir -p /var/lib/dbus/
          cp /etc/machine-id /var/lib/dbus/
