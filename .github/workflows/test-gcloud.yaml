name: Test gcloud authentication
on:
  pull_request:
  workflow_dispatch:

permissions: read-all

jobs:
  test-gcp:
    name: Upload to GCP
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - id: "auth"
        name: "Authenticate to GCP"
        uses: 'google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f' # v2
        with:
          create_credentials_file: true
          workload_identity_provider: 'projects/908384205599/locations/global/workloadIdentityPools/github/providers/kairos'
          service_account: 'github-service-account@palette-kairos.iam.gserviceaccount.com'
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a' # v2
      - name: Build and push GCP image
        run: |
          set -xe

          #gcloud auth login --brief --cred-file="${{ steps.auth.outputs.credentials_file_path }}"

          gcloud auth print-access-token --impersonate-service-account=github-service-account@palette-kairos.iam.gserviceaccount.com
