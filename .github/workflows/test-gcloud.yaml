name: Test gcloud authentication
on:
  pull_request:
  workflow_dispatch:

permissions: read-all

jobs:
  test-gcp:
    name: Upload to GCP
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # REQUIRED for OIDC authentication
      contents: read
    steps:
      - id: "auth"
        name: "Authenticate to GCP"
        uses: 'google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f' # v2
        with:
          #token_format: "id_token"
          #id_token_audience: "projects/908384205599/locations/global/workloadIdentityPools/github/providers/kairos"
          create_credentials_file: true
          workload_identity_provider: 'projects/908384205599/locations/global/workloadIdentityPools/github/providers/kairos'
          service_account: 'github-service-account@palette-kairos.iam.gserviceaccount.com'
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a' # v2
      - name: Build and push GCP image
        run: |
          set -xe

          #gcloud auth login --brief --cred-file="${{ steps.auth.outputs.credentials_file_path }}"
          cat "${{ steps.auth.outputs.credentials_file_path }}"

          echo "${{ steps.auth.outputs.id_token }}" | jq .

          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          gcloud config list account
          gcloud auth print-access-token
          gcloud projects get-iam-policy palette-kairos --format=json | jq '.bindings[] | select(.role=="roles/iam.serviceAccountTokenCreator")'

          gcloud auth print-access-token --impersonate-service-account=github-service-account@palette-kairos.iam.gserviceaccount.com
