name: Bump repositories
on:
  schedule:
    - cron: 0 20 * * *
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install earthly
        uses: Luet-lab/luet-install-action@v1
        with:
          repository: quay.io/kairos/packages
          packages: utils/earthly
      - name: Old packages
        run: |
          earthly +base-image --VARIANT=standard --FLAVOR=opensuse-leap --K3S_VERSION=latest
          mv build/versions.yaml build/versions.old.yaml
      - name: Bump cos ðŸ”§
        run: earthly +bump-repositories
      - name: New packages
        run: |
          earthly +base-image --VARIANT=standard --FLAVOR=opensuse-leap --K3S_VERSION=latest
          mv build/versions.yaml build/versions.new.yaml
      - name: Diff versions
        run: |
          yq -i -P '.|=sort_by(.name)|.[]|[{"name": .name, "category": .category, "version": .version}]' build/versions.old.yaml
          yq -i -P '.|=sort_by(.name)|.[]|[{"name": .name, "category": .category, "version": .version}]' build/versions.new.yaml
          echo "Bump of Kairos repositories" > pr-message
          echo "--------------------------" >> pr-message
          DIFF=$(diff -u build/versions.old.yaml build/versions.new.yaml)
          if [[ $? == 1 ]]; then
            echo "> [\!WARNING]" >> pr-message
            echo "> There were changes to installed packages" >> pr-message
            echo "\`\`\`diff" >> pr-message
            echo "${DIFF}" >> pr-message
            echo "\`\`\`" >> pr-message
            echo "\n" >> pr-message
          fi
          echo "> [\!IMPORTANT]" >> pr-message
          echo "> Full package list from new repo" >> pr-message
          echo "\`\`\`yaml" >> pr-message
          echo "$(cat build/versions.new.yaml)" >> pr-message
          echo "\`\`\`" >> pr-message
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          push-to-fork: ci-robbot/c3os
          commit-message: ':arrow_up: Update repositories'
          title: ':arrow_up: Update repositories'
          body-path: pr-message
          signoff: true
